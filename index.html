<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pi≈üti Pro - Modern</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f2027; --gold: #ffd700; --gold-dark: #d4af37; --card-w: 80px; --card-h: 115px; }
        
        body { 
            background: linear-gradient(to bottom, #203a43, #2c5364); 
            color: white; 
            font-family: 'Poppins', sans-serif;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 10px;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* OYUN LOGOSU */
        h1 {
            font-size: 2.2rem;
            margin: 15px 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: -webkit-linear-gradient(var(--gold), var(--gold-dark));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 4px 10px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        /* MODERNIZE EDƒ∞LMƒ∞≈û PANEL (CAM EFEKTƒ∞) */
        .panel { 
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 25px 20px; 
            border-radius: 20px; 
            text-align: center; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
            width: 100%; 
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.18); 
            margin-top: 5px;
            position: relative;
            box-sizing: border-box;
        }

        /* Gƒ∞Rƒ∞≈û INPUTLARI */
        input, select {
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
            outline: none;
            transition: 0.3s;
            font-family: 'Poppins', sans-serif;
        }
        input:focus, select:focus { border-color: var(--gold); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        ::placeholder { color: rgba(255,255,255,0.5); }

        /* YAN YANA DURAN SE√áƒ∞M KUTULARI */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        .input-group select { flex: 2; margin-bottom: 0; }
        .input-group input { flex: 1; margin-bottom: 0; text-align: center; }

        /* BUTONLAR */
        button { 
            padding: 15px; 
            background: linear-gradient(45deg, var(--gold), #f39c12); 
            border: none; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 16px; 
            color: #1a1a1a;
            cursor: pointer; 
            margin: 8px 0; 
            width: 100%; 
            box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: 'Poppins', sans-serif;
        }
        button:active { transform: scale(0.98); }
        button:hover { opacity: 0.9; }

        /* √ñZEL BUTON RENKLERƒ∞ */
        .btn-blue { background: linear-gradient(45deg, #3498db, #2980b9); color: white; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); }
        .btn-purple { background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4); }
        .btn-red { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); }

        /* √áƒ±kƒ±≈ü Yap Butonu (Saƒü √ºstte minik) */
        .cikis-yap-btn { 
            background: rgba(231, 76, 60, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(231, 76, 60, 0.5);
            width: auto; 
            padding: 6px 12px; 
            font-size: 12px; 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            margin: 0;
            box-shadow: none;
        }

        /* OYUN ALANI */
        #oyun-alani { display: none; width: 100%; flex-direction: column; align-items: center; position: relative; max-width: 500px; }
        
        .el-sayaci { 
            background: rgba(241, 196, 15, 0.1); 
            border: 1px solid var(--gold); 
            padding: 5px 20px; 
            border-radius: 30px; 
            font-size: 14px; 
            font-weight: bold; 
            color: var(--gold); 
            margin-bottom: 10px; 
        }

        .masa { 
            width: 100%; 
            height: 260px; 
            border: 2px dashed rgba(255,255,255,0.2); 
            border-radius: 20px; 
            background: rgba(255,255,255,0.02); 
            margin: 10px 0; 
            position: relative; 
        }
        
        .el { display: flex; gap: 8px; justify-content: center; min-height: 120px; margin-top: 10px; }
        
        .kart { 
            width: var(--card-w); 
            height: var(--card-h); 
            background: white; 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            padding: 5px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            font-size: 18px;
            font-weight: bold;
            position: absolute;
            transition: 0.3s ease;
            box-sizing: border-box;
        }
        .el .kart { position: relative; cursor: pointer; }
        .el .kart:hover { transform: translateY(-10px); }

        .kirmizi { color: #e74c3c; } 
        .siyah { color: #2c3e50; }
        .oyuncu-etiket { font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 2px; }

        /* PROFƒ∞L KARTI */
        #profil-bilgi {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 12px;
            margin: 35px 0 20px 0;
            border: 1px solid rgba(255,255,255,0.05);
            font-size: 14px;
            line-height: 1.6;
        }

        /* TABLOLAR VE Lƒ∞STELER */
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; font-size: 13px; color: white; margin-top: 10px; }
        th { color: var(--gold); padding: 8px; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; }
        td { background: rgba(255,255,255,0.05); padding: 10px; text-align: center; }
        tr:first-child td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        tr:first-child td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
        
        #masa-listesi div {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        #masa-listesi .buton-grubu {
            display: flex;
            gap: 5px;
        }

        /* EFECTLER */
        @keyframes pistiPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; filter: drop-shadow(0 0 30px gold); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        #pisti-efekt { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 50px; font-weight: 900; color: var(--gold); text-shadow: 0 5px 15px rgba(0,0,0,0.5); pointer-events: none; z-index: 1000; display: none; width: 100%; text-align: center; }
        .pisti-anim { display: block !important; animation: pistiPop 1.5s ease-out forwards; }
        
        /* Linkler */
        .form-link { font-size: 13px; margin-top: 15px; color: rgba(255,255,255,0.6); }
    </style>
</head>
<body>

    <div id="pisti-efekt">Pƒ∞≈ûTƒ∞!</div>

    <h1>Pƒ∞≈ûTƒ∞ PRO</h1>

    <div id="giris-ekrani" class="panel">
        <h2 id="form-baslik" style="color: var(--gold); margin: 0 0 20px 0;">Giri≈ü Yap</h2>
        
        <div id="kayit-ozel-alan" style="display: none;">
            <input type="text" id="adSoyad" placeholder="Ad Soyad">
        </div>
        
        <input type="email" id="email" placeholder="E-posta">
        <input type="password" id="sifre" placeholder="≈ûifre">
        
        <div style="margin-top: 10px;">
            <button id="ana-islem-btn" onclick="girisYap()" class="btn-blue">Giri≈ü Yap</button>
            <p id="form-degistir-text" class="form-link">
                Hesabƒ±nƒ±z yok mu? <span onclick="toggleForm('kayit')" style="color:var(--gold); cursor:pointer; text-decoration:underline;">Kayƒ±t Ol</span>
            </p>
        </div>
    </div>

    <div id="lobi-ekrani" class="panel" style="display:none;">
        <button class="cikis-yap-btn" onclick="otaturumuKapat()">√áƒ±kƒ±≈ü</button>
        
        <div id="profil-bilgi"></div>
        
        <div class="input-group">
            <select id="mod-secim">
                <option value="bot">ü§ñ Bot (Tek)</option>
                <option value="2">üë• 2 Ki≈üilik</option>
                <option value="4">ü§ù E≈üli (2v2)</option>
            </select>
            <input type="number" id="bitis-puani" value="101" placeholder="Puan">
        </div>
        
        <button onclick="masaKur()">Masa Kur</button>
        <button onclick="liderlikTablosuGoster()" class="btn-purple">üèÜ Liderlik Tablosu</button>
        
        <div id="liderlik-listesi" style="margin-top: 15px;"></div>
        
        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
        <h3 style="font-size:16px; margin:0 0 10px 0; color:var(--gold)">A√ßƒ±k Masalar</h3>
        <div id="masa-listesi" style="text-align: left;">Masalar y√ºkleniyor...</div>
    </div>

    <div id="oyun-alani">
        <button class="ayril-btn btn-red" onclick="oyundanAyril()" style="width: auto; position: absolute; top: 0; right: 0; padding: 6px 15px; font-size: 12px; z-index: 100;">Ayrƒ±l</button>
        
        <div id="aktif-el-display" class="el-sayaci">1. El</div>
        
        <div id="rakip-ismi" class="oyuncu-etiket">Oyuncular Bekleniyor...</div>
        <div id="deste-bilgi" style="font-size: 12px; opacity: 0.6; margin-bottom: 5px;">Destede Kalan: 52</div>
        <div id="durum" style="font-weight: bold; color: var(--gold); margin-bottom: 5px; font-size: 14px;">Baƒülanƒ±lƒ±yor...</div>
        
        <div class="masa" id="yerdeki-kartlar"></div>
        
        <div id="benim-ismim" class="oyuncu-etiket">Siz</div>
        <div class="el" id="benim-elim"></div>
        
        <div id="skor-tablosu-konteynir" style="width: 100%; margin-top: 20px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
            <table>
                <thead>
                    <tr>
                        <th>El</th>
                        <th id="th-oyuncu1">1. Taraf</th>
                        <th id="th-oyuncu2">2. Taraf</th>
                    </tr>
                </thead>
                <tbody id="tablo-govde"></tbody>
            </table>
            <button id="lobiye-don" style="display:none; margin-top:15px;" onclick="location.reload()">Lobiye D√∂n</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBBiXjQRhUSXwbgoOmcKQ3Gq0UKplZAZBY",
            authDomain: "pisti-f0c29.firebaseapp.com",
            databaseURL: "https://pisti-f0c29-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pisti-f0c29",
            storageBucket: "pisti-f0c29.firebasestorage.app",
            messagingSenderId: "85802639604",
            appId: "1:85802639604:web:98ffe6d21f3d1651f0bea1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let aktifUser = null, aktifMasaId = null, benimRolum = null, benimIsmim = "";

        // AUTH VE FORM ƒ∞≈ûLEMLERƒ∞
        window.toggleForm = (mod) => {
            const kayitAlani = document.getElementById('kayit-ozel-alan');
            const baslik = document.getElementById('form-baslik');
            const btn = document.getElementById('ana-islem-btn');
            const text = document.getElementById('form-degistir-text');
            if(mod === 'kayit') {
                kayitAlani.style.display = 'block'; baslik.textContent = 'Kayƒ±t Ol'; btn.textContent = 'Kayƒ±t Ol';
                btn.onclick = () => window.kayitOl();
                text.innerHTML = `Zaten hesabƒ±nƒ±z var mƒ±? <span onclick="toggleForm('giris')" style="color:var(--gold); cursor:pointer; text-decoration:underline;">Giri≈ü Yap</span>`;
            } else {
                kayitAlani.style.display = 'none'; baslik.textContent = 'Giri≈ü Yap'; btn.textContent = 'Giri≈ü Yap';
                btn.onclick = () => window.girisYap();
                text.innerHTML = `Hesabƒ±nƒ±z yok mu? <span onclick="toggleForm('kayit')" style="color:var(--gold); cursor:pointer;">Kayƒ±t Ol</span>`;
            }
        };

        window.kayitOl = () => {
            const ad = document.getElementById('adSoyad').value, m = document.getElementById('email').value, s = document.getElementById('sifre').value;
            if(!ad) return alert("L√ºtfen adƒ±nƒ±zƒ± girin.");
            createUserWithEmailAndPassword(auth, m, s).then(res => {
                set(ref(db, 'users/' + res.user.uid), { adSoyad: ad, email: m, genelPuan: 0, oyunSayisi: 0, galibiyet: 0, sonBes: [] });
            }).catch(e => alert("Kayƒ±t hatasƒ±: " + e.message));
        };

        window.girisYap = () => {
            const m = document.getElementById('email').value, s = document.getElementById('sifre').value;
            signInWithEmailAndPassword(auth, m, s).catch(e => alert("Giri≈ü hatasƒ±: " + e.message));
        };

        window.otaturumuKapat = () => { if(confirm("√áƒ±kƒ±≈ü yapmak istediƒüinize emin misiniz?")) signOut(auth).then(() => location.reload()); };

        onAuthStateChanged(auth, user => { 
            if(user) { 
                aktifUser = user; document.getElementById('giris-ekrani').style.display='none'; document.getElementById('lobi-ekrani').style.display='block';
                onValue(ref(db, `users/${user.uid}`), s => {
                    const d = s.val(); if(d) { benimIsmim = d.adSoyad; document.getElementById('profil-bilgi').innerHTML = `<b>${d.adSoyad}</b><br>Genel Puan: <span style="color:var(--gold)">${d.genelPuan || 0}</span>`; }
                });
                lobiTakip(); 
            } else {
                document.getElementById('giris-ekrani').style.display='block'; document.getElementById('lobi-ekrani').style.display='none';
            }
        });

        // OYUN VE MASA Y√ñNETƒ∞Mƒ∞
        function lobiTakip() {
            onValue(ref(db, 'lobiler/'), snap => {
                const list = document.getElementById('masa-listesi'); list.innerHTML = "";
                const data = snap.val(); 
                
                if(!data) { list.innerHTML = "Aktif masa yok."; return; }
                
                for(let id in data) {
                    if(data[id].durum === "bekliyor") {
                        const count = data[id].oyuncular ? Object.keys(data[id].oyuncular).length : 0;
                        const modStr = data[id].mod === "4" ? "E≈üli" : "2 Ki≈üilik";
                        const div = document.createElement('div');
                        
                        // Rol kontrol√º yap
                        const isOwner = data[id].oyuncular.oyuncu1.uid === aktifUser.uid;
                        let myExistingRole = null;
                        
                        // Zaten masada mƒ±yƒ±m kontrol√º (Oyuncu 1 deƒüilsem ama 2,3,4 isem)
                        if(data[id].oyuncular) {
                            Object.entries(data[id].oyuncular).forEach(([key, val]) => {
                                if(val.uid === aktifUser.uid) myExistingRole = key;
                            });
                        }

                        let buttonHtml = "";
                        
                        if (isOwner) {
                            // Masa sahibi hem d√∂nebilir hem silebilir
                            buttonHtml = `
                                <button onclick="masaGiris('${id}', 'oyuncu1')" class="btn-blue" style="width:auto; padding:5px 10px; font-size:12px; margin:0 5px 0 0;">Oyuna D√∂n</button>
                                <button onclick="masaSil('${id}')" class="btn-red" style="width:auto; padding:5px 10px; font-size:12px; margin:0;">Sil</button>
                            `;
                        } else if (myExistingRole) {
                            // Zaten masadayƒ±m (refresh sonrasƒ± vs)
                            buttonHtml = `<button onclick="masaGiris('${id}', '${myExistingRole}')" class="btn-purple" style="width:auto; padding:5px 10px; font-size:12px; margin:0;">Devam Et</button>`;
                        } else {
                            // Yeni katƒ±lƒ±mcƒ±
                            buttonHtml = `<button onclick="masaKatil('${id}')" class="btn-blue" style="width:auto; padding:5px 10px; font-size:12px; margin:0;">Katƒ±l</button>`;
                        }

                        div.innerHTML = `<span><b>${data[id].oyuncular.oyuncu1.isim}</b> (${modStr})</span> <div class="buton-grubu">${buttonHtml}</div>`;
                        list.appendChild(div);
                    }
                }
            });
        }

        window.masaSil = async (id) => { if(confirm("Masayƒ± silmek istediƒüinize emin misiniz?")) await remove(ref(db, 'lobiler/' + id)); };

        window.masaKur = async () => {
            const mod = document.getElementById('mod-secim').value, bitis = document.getElementById('bitis-puani').value, id = "masa_" + Date.now();
            const yeniMasa = { 
                mod: mod, hedef: parseInt(bitis), durum: mod === "bot" ? "basladi" : "bekliyor", 
                sira: "oyuncu1", sonKazan: "oyuncu1", masaKartlari: [], skorGecmisi: [], 
                oyuncular: { oyuncu1: { uid: aktifUser.uid, isim: benimIsmim, puan: 0, alinan: [], toplamSkor: 0, pistiSayisi: 0 } } 
            };
            if(mod === "bot") { 
                yeniMasa.oyuncular.oyuncu2 = { uid: "BOT", isim: "Bilgisayar", puan: 0, alinan: [], toplamSkor: 0, pistiSayisi: 0 }; 
                const d = desteYap(); yeniMasa.masaKartlari = d.splice(0,4); yeniMasa.oyuncular.oyuncu1.el = d.splice(0,4); yeniMasa.oyuncular.oyuncu2.el = d.splice(0,4); yeniMasa.deste = d; 
            }
            await set(ref(db, 'lobiler/' + id), yeniMasa); 
            window.masaGiris(id, "oyuncu1");
        };

        window.masaKatil = async (id) => {
            try {
                const snap = await get(ref(db, `lobiler/${id}`)); 
                const oyun = snap.val();
                
                if (!oyun) { alert("Masa bulunamadƒ±."); return; }

                // Kullanƒ±cƒ± zaten masada mƒ± kontrol et (Hata √∂nleyici)
                let existingRole = null;
                if(oyun.oyuncular) {
                    Object.entries(oyun.oyuncular).forEach(([key, val]) => {
                        if(val.uid === aktifUser.uid) existingRole = key;
                    });
                }

                if(existingRole) {
                    window.masaGiris(id, existingRole);
                    return;
                }

                // Yeni oyuncu ekle
                const idx = Object.keys(oyun.oyuncular).length + 1; 
                const rol = "oyuncu" + idx;
                
                let up = { [`oyuncular/${rol}`]: { uid: aktifUser.uid, isim: benimIsmim, puan: 0, alinan: [], toplamSkor: 0, pistiSayisi: 0 } };
                const max = oyun.mod === "4" ? 4 : 2;
                
                if(idx === max) {
                    const d = desteYap(); up.durum = "basladi"; up.masaKartlari = d.splice(0,4); up.deste = d;
                    for(let i=1; i<=max; i++) up[`oyuncular/oyuncu${i}/el`] = d.splice(0,4);
                }
                
                await update(ref(db, `lobiler/${id}`), up); 
                window.masaGiris(id, rol);
            } catch(e) {
                console.error(e);
                alert("Masaya katƒ±lƒ±rken hata olu≈ütu: " + e.message);
            }
        };

        window.masaGiris = (id, rol) => {
            aktifMasaId = id; 
            benimRolum = rol;
            
            // Ekran deƒüi≈ütir
            document.getElementById('lobi-ekrani').style.display = 'none'; 
            document.getElementById('oyun-alani').style.display = 'flex';
            
            // Masayƒ± dinlemeye ba≈üla
            onValue(ref(db, `lobiler/${id}`), snap => { 
                const data = snap.val(); 
                if(data) { 
                    oyunGuncelle(data); 
                    if(data.durum === "basladi" && data.mod === "bot" && data.sira === "oyuncu2") setTimeout(botHamlesi, 1000); 
                } else {
                    // Masa silindiyse lobiye at
                    alert("Masa kapatƒ±ldƒ±.");
                    location.reload();
                }
            });
        };

        // OYUN AKI≈ûI
        function oyunGuncelle(data) {
            const yer = document.getElementById('yerdeki-kartlar'), elDiv = document.getElementById('benim-elim');
            const elSayaci = document.getElementById('aktif-el-display');
            
            const guncelEl = (data.skorGecmisi ? data.skorGecmisi.length : 0) + 1;
            elSayaci.textContent = `${guncelEl}. El`;

            document.getElementById('deste-bilgi').textContent = `Destede Kalan: ${data.deste ? data.deste.length : 0} kart`;

            if(data.mod === "4") {
                document.getElementById('th-oyuncu1').textContent = `1. Takƒ±m`;
                document.getElementById('th-oyuncu2').textContent = `2. Takƒ±m`;
            } else {
                document.getElementById('th-oyuncu1').textContent = data.oyuncular.oyuncu1.isim;
                document.getElementById('th-oyuncu2').textContent = data.oyuncular.oyuncu2 ? data.oyuncular.oyuncu2.isim : "Bekleniyor...";
            }

            if(data.durum === "bitti") {
                yer.innerHTML = ""; elDiv.innerHTML = "";
                document.getElementById('durum').innerHTML = "üèÜ OYUN Bƒ∞TTƒ∞ üèÜ";
                document.getElementById('lobiye-don').style.display = "block";
                skorTablosuGuncelle(data); return;
            }

            document.getElementById('durum').textContent = data.sira === benimRolum ? "SIRA Sƒ∞ZDE" : "RAKƒ∞PTE...";
            yer.innerHTML = "";
            const mk = data.masaKartlari || [];
            let gap = Math.max(10, Math.min(25, 350 / (mk.length + 1)));
            mk.forEach((k, i) => {
                const div = document.createElement('div'); div.innerHTML = kartHtml(k, i, false);
                const kd = div.firstChild; kd.style.left = `calc(50% + ${(i * gap) - (mk.length * gap / 2)}px)`;
                kd.style.top = "50%"; kd.style.transform = "translateY(-50%)"; kd.style.zIndex = i;
                if(i === mk.length - 1) kd.style.border = "2px solid var(--gold)";
                yer.appendChild(kd);
            });

            elDiv.innerHTML = "";
            (data.oyuncular[benimRolum]?.el || []).forEach((k, i) => {
                const div = document.createElement('div'); div.innerHTML = kartHtml(k, i, true);
                elDiv.appendChild(div.firstChild);
            });
            skorTablosuGuncelle(data);
        }

        window.kartAt = async (idx) => {
            const snap = await get(ref(db, `lobiler/${aktifMasaId}`)); const oyun = snap.val();
            if(!oyun || oyun.sira !== benimRolum) return;
            const hamle = calculateMove(oyun, benimRolum, idx);
            await update(ref(db, `lobiler/${aktifMasaId}`), hamle.updates);
            if(hamle.updates.durum === "hesapla") finalHesapla(aktifMasaId);
        };

        function calculateMove(oyun, suankiSira, idx) {
            let el = [...oyun.oyuncular[suankiSira].el]; let atilan = el.splice(idx, 1)[0];
            let masa = oyun.masaKartlari || []; let pPuan = oyun.oyuncular[suankiSira].puan || 0;
            let pSayisi = oyun.oyuncular[suankiSira].pistiSayisi || 0;
            let alinan = oyun.oyuncular[suankiSira].alinan || []; let sonKazan = oyun.sonKazan;
            let max = oyun.mod === "4" ? 4 : 2;
            let siradaki = "oyuncu" + ((parseInt(suankiSira.replace("oyuncu", "")) % max) + 1);

            if(masa.length > 0) {
                let ust = masa[masa.length - 1];
                if(atilan.value === "J" || atilan.value === ust.value) {
                    sonKazan = suankiSira;
                    let mText = atilan.value === "J" ? "VALE ƒ∞LE ALDI!" : `${atilan.value} E≈ûLEMESƒ∞!`;
                    if(masa.length === 1 && atilan.value === {value: ust.value}.value) { 
                        mText = atilan.value === "J" ? "VALE Pƒ∞≈ûTƒ∞!" : "Pƒ∞≈ûTƒ∞!";
                        pPuan += (atilan.value === "J") ? 25 : 10; pSayisi += 1;
                    }
                    pistiEfektiGoster(mText); alinan = [...alinan, ...masa, atilan]; masa = [];
                } else masa.push(atilan);
            } else masa.push(atilan);

            let updates = { masaKartlari: masa, sira: siradaki, sonKazan: sonKazan };
            updates[`oyuncular/${suankiSira}/el`] = el; updates[`oyuncular/${suankiSira}/puan`] = pPuan; 
            updates[`oyuncular/${suankiSira}/pistiSayisi`] = pSayisi; updates[`oyuncular/${suankiSira}/alinan`] = alinan;
            
            let bittiMi = true;
            for(let i=1; i<=max; i++) { if((i === parseInt(suankiSira.replace("oyuncu","")) ? el : (oyun.oyuncular["oyuncu"+i].el || [])).length > 0) bittiMi = false; }
            if(bittiMi) {
                if(oyun.deste && oyun.deste.length > 0) {
                    let d = [...oyun.deste]; for(let i=1; i<=max; i++) updates[`oyuncular/oyuncu${i}/el`] = d.splice(0, 4);
                    updates.deste = d;
                } else updates.durum = "hesapla";
            }
            return { updates };
        }

        async function finalHesapla(id) {
            const snap = await get(ref(db, `lobiler/${id}`)); const oyun = snap.val();
            const mod = oyun.mod;

            const getDetayliPuan = (cards) => {
                let p = 0; let d = [];
                (cards || []).forEach(k => {
                    if(k.value === "A") { p += 1; d.push("A"); }
                    if(k.value === "J") { p += 1; d.push("J"); }
                    if(k.suit === "‚ô£" && k.value === "2") { p += 2; d.push("‚ô£2"); }
                    if(k.suit === "‚ô¶" && k.value === "10") { p += 3; d.push("‚ô¶10"); }
                });
                let counts = {}; d.forEach(x => counts[x] = (counts[x] || 0) + 1);
                let finalD = Object.entries(counts).map(([k, v]) => v > 1 ? `${v}x${k}` : k).join(", ");
                return { p, detay: finalD };
            };

            let players = [];
            for(let i=1; i<=(mod==="4"?4:2); i++) {
                let pData = oyun.oyuncular["oyuncu"+i];
                let alinan = [...(pData.alinan || [])];
                if(oyun.sonKazan === "oyuncu"+i) alinan.push(...(oyun.masaKartlari || []));
                let pInfo = getDetayliPuan(alinan);
                players.push({ id: "oyuncu"+i, puan: pData.puan + pInfo.p, count: alinan.length, detay: pInfo.detay, pisti: pData.pistiSayisi });
            }

            let t1, t2, det1, det2, t1k, t2k;
            if(mod === "4") {
                t1 = players[0].puan + players[2].puan; t2 = players[1].puan + players[3].puan;
                t1k = players[0].count + players[2].count; t2k = players[1].count + players[3].count;
                let pisti1 = players[0].pisti + players[2].pisti, pisti2 = players[1].pisti + players[3].pisti;
                det1 = (pisti1 > 0 ? `<span class="badge-detay" style="background:rgba(255,255,255,0.2); padding:0 3px; border-radius:3px;">${pisti1} Pi≈üti</span> ` : "") + [players[0].detay, players[2].detay].filter(Boolean).join(", ");
                det2 = (pisti2 > 0 ? `<span class="badge-detay" style="background:rgba(255,255,255,0.2); padding:0 3px; border-radius:3px;">${pisti2} Pi≈üti</span> ` : "") + [players[1].detay, players[3].detay].filter(Boolean).join(", ");
            } else {
                t1 = players[0].puan; t2 = players[1].puan; t1k = players[0].count; t2k = players[1].count;
                det1 = (players[0].pisti > 0 ? `<span class="badge-detay" style="background:rgba(255,255,255,0.2); padding:0 3px; border-radius:3px;">${players[0].pisti} Pi≈üti</span> ` : "") + players[0].detay;
                det2 = (players[1].pisti > 0 ? `<span class="badge-detay" style="background:rgba(255,255,255,0.2); padding:0 3px; border-radius:3px;">${players[1].pisti} Pi≈üti</span> ` : "") + players[1].detay;
            }

            if(t1k > t2k) { t1 += 3; det1 += (det1 ? ", " : "") + "Kart Fazlasƒ±"; }
            else if(t2k > t1k) { t2 += 3; det2 += (det2 ? ", " : "") + "Kart Fazlasƒ±"; }

            const s1 = (oyun.oyuncular.oyuncu1.toplamSkor || 0) + t1, s2 = (oyun.oyuncular.oyuncu2.toplamSkor || 0) + t2;
            const bitti = s1 >= oyun.hedef || s2 >= oyun.hedef;

            const up = { 
                skorGecmisi: [...(oyun.skorGecmisi || []), { oyuncu1: t1, oyuncu2: t2, d1: det1, d2: det2 }], 
                durum: bitti ? "bitti" : "basladi" 
            };

            for(let i=1; i<=(mod==="4"?4:2); i++) { 
                up[`oyuncular/oyuncu${i}/toplamSkor`] = (i % 2 !== 0) ? s1 : s2; 
                up[`oyuncular/oyuncu${i}/puan`] = 0; up[`oyuncular/oyuncu${i}/alinan`] = []; up[`oyuncular/oyuncu${i}/pistiSayisi`] = 0;
            }

            if(!bitti) {
                const d = desteYap(); up.masaKartlari = d.splice(0,4); up.deste = d;
                for(let i=1; i<=(mod==="4"?4:2); i++) up[`oyuncular/oyuncu${i}/el`] = d.splice(0,4);
                pistiEfektiGoster(`${(oyun.skorGecmisi ? oyun.skorGecmisi.length : 0) + 2}. El Ba≈ülƒ±yor!`);
            }
            await update(ref(db, `lobiler/${id}`), up);
        }

        // YARDIMCI ARA√áLAR
        function kartHtml(k, i, t) {
            return `<div class="kart ${k.color}" ${t ? `onclick="kartAt(${i})"` : ""}>
                <div style="font-size:14px;">${k.value}</div><div style="font-size:28px; text-align:center">${k.suit}</div><div style="transform:rotate(180deg); font-size:14px;">${k.value}</div>
            </div>`;
        }

        function desteYap() {
            const s = ["‚ô•","‚ô¶","‚ô£","‚ô†"], v = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
            let d = []; s.forEach(x => v.forEach(y => d.push({suit:x, value:y, color:(x==="‚ô•"||x==="‚ô¶")?"kirmizi":"siyah"})));
            return d.sort(() => Math.random() - 0.5);
        }

        function skorTablosuGuncelle(data) {
            const govde = document.getElementById('tablo-govde'); govde.innerHTML = "";
            (data.skorGecmisi || []).forEach((s, i) => { 
                govde.innerHTML += `<tr><td>${i+1}</td><td>${s.oyuncu1} <br><span style="font-size:10px; opacity:0.7">${s.d1 || ""}</span></td><td>${s.oyuncu2} <br><span style="font-size:10px; opacity:0.7">${s.d2 || ""}</span></td></tr>`; 
            });
            govde.innerHTML += `<tr style="color:var(--gold); font-weight:bold; background:rgba(255,255,255,0.1)"><td>TOPLAM</td><td>${data.oyuncular.oyuncu1.toplamSkor}</td><td>${data.oyuncular.oyuncu2.toplamSkor}</td></tr>`;
        }

        function pistiEfektiGoster(msg) {
            const el = document.getElementById('pisti-efekt');
            el.textContent = msg; el.classList.remove('pisti-anim');
            void el.offsetWidth; el.classList.add('pisti-anim');
            setTimeout(() => el.classList.remove('pisti-anim'), 2000);
        }

        async function botHamlesi() {
            const snap = await get(ref(db, `lobiler/${aktifMasaId}`)); const oyun = snap.val();
            if(!oyun || oyun.sira !== "oyuncu2" || oyun.durum !== "basladi") return;
            const botEli = oyun.oyuncular.oyuncu2.el || []; if(botEli.length === 0) return;
            let idx = 0; const yerdeki = (oyun.masaKartlari && oyun.masaKartlari.length > 0) ? oyun.masaKartlari[oyun.masaKartlari.length - 1] : null;
            botEli.forEach((k, i) => { if(yerdeki && (k.value === yerdeki.value || k.value === "J")) idx = i; });
            const hamle = calculateMove(oyun, "oyuncu2", idx);
            await update(ref(db, `lobiler/${aktifMasaId}`), hamle.updates);
            if(hamle.updates.durum === "hesapla") finalHesapla(aktifMasaId);
        }

        window.liderlikTablosuGoster = async () => {
            const s = await get(ref(db, 'users/')); const data = s.val();
            let arr = data ? Object.values(data).sort((a,b) => (b.genelPuan || 0) - (a.genelPuan || 0)) : [];
            let html = `<h3>üèÜ Liderlik Tablosu</h3><table><thead><tr><th>Oyuncu</th><th>Puan</th><th>Ma√ßlar</th></tr></thead><tbody>`;
            arr.forEach(u => {
                html += `<tr><td>${u.adSoyad}</td><td style="color:var(--gold); font-weight:bold">${u.genelPuan||0}</td><td>${u.oyunSayisi||0}</td></tr>`;
            });
            document.getElementById('liderlik-listesi').innerHTML = html + "</tbody></table>";
        };

        window.oyundanAyril = async () => {
            if(confirm("Masadan ayrƒ±lmak √ºzeresiniz. Puan kaybedebilirsiniz?")) {
                const snap = await get(ref(db, `lobiler/${aktifMasaId}`)); const oyun = snap.val();
                if(oyun && oyun.durum === "basladi" && oyun.mod !== "bot") {
                    const r = ref(db, `users/${aktifUser.uid}`); const s = await get(r); const d = s.val();
                    if(d) await update(r, { genelPuan: (d.genelPuan || 0) - 100 });
                }
                location.reload();
            }
        };

        // Bu fonksiyonu global scope'a a√ßƒ±k√ßa atayalƒ±m
        window.masaGiris = masaGiris;
    </script>
</body>
</html>