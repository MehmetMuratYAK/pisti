<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pi≈üti Pro - El Bilgisi Modu</title>
    <style>
        :root { --bg: #0d2a1a; --gold: #f1c40f; --card-w: 85px; --card-h: 125px; }
        body { background: radial-gradient(circle, #1a472a 0%, var(--bg) 100%); color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; overflow-x: hidden; }
        
        /* Animasyonlar */
        @keyframes pistiPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; filter: drop-shadow(0 0 30px gold); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        @keyframes fadeSlide {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        #pisti-efekt { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; font-weight: bold; color: var(--gold); text-shadow: 0 0 20px black; pointer-events: none; z-index: 1000; display: none; text-align: center; }
        .pisti-anim { display: block !important; animation: pistiPop 1.5s ease-out forwards; }
        
        /* Panel ve Butonlar */
        .panel { background: rgba(0,0,0,0.9); padding: 25px; border-radius: 15px; margin-top: 30px; text-align:center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90px; max-width: 420px; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        #oyun-alani { display: none; width: 100%; flex-direction: column; align-items: center; padding-top: 10px; position: relative; }
        
        button { padding: 12px; background: var(--gold); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px; width: 100%; transition: 0.3s; }
        button:hover { opacity: 0.8; transform: scale(1.02); }
        .cikis-yap-btn { background: #e74c3c; color: white; width: auto; padding: 5px 12px; font-size: 12px; position: absolute; top: 10px; right: 10px; border-radius: 5px; }
        .ayril-btn { background: #c0392b !important; color: white !important; width: auto !important; padding: 8px 20px !important; position: absolute; top: 10px; right: 20px; z-index: 10; }

        /* Oyun Elementleri */
        .el-sayaci { background: rgba(241, 196, 15, 0.2); border: 1px solid var(--gold); padding: 5px 20px; border-radius: 30px; font-size: 20px; font-weight: bold; color: var(--gold); margin-bottom: 10px; animation: fadeSlide 0.5s ease-out; }
        .masa { width: 90%; height: 260px; border: 3px solid rgba(241, 196, 15, 0.4); border-radius: 125px; background: rgba(0,0,0,0.2); margin: 15px 0; position: relative; overflow: hidden; }
        .el { display: flex; gap: 10px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; min-height: 140px; }
        
        /* Kartlar */
        .kart { width: var(--card-w); height: var(--card-h); background: white; border-radius: 10px; display: flex; flex-direction: column; justify-content: space-between; padding: 8px; font-weight: bold; font-size: 18px; box-shadow: 0 5px 10px rgba(0,0,0,0.4); border: 1px solid #ccc; position: absolute; transition: 0.3s ease; }
        .kirmizi { color: #e74c3c; }
        .siyah { color: #2c3e50; }
        .el .kart { position: relative; cursor: pointer; }
        .oyuncu-etiket { font-size: 18px; font-weight: bold; color: var(--gold); margin: 5px 0; }

        /* Bilgi Alanlarƒ± */
        #deste-bilgi { background: rgba(255, 255, 255, 0.1); padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.2); }
        table { width: 100%; border-collapse: collapse; text-align: center; font-size: 13px; margin-top: 10px; color: white; background: rgba(0,0,0,0.3); }
        th, td { padding: 8px; border: 1px solid rgba(241, 196, 15, 0.2); }
        th { background: var(--gold); color: black; }
        .detay-text { font-size: 11px; color: #ddd; display: block; margin-top: 4px; line-height: 1.4; }
        .badge-detay { background: rgba(255,255,255,0.15); padding: 1px 4px; border-radius: 4px; margin: 0 2px; }
    </style>
</head>
<body>

    <div id="pisti-efekt">Pƒ∞≈ûTƒ∞!</div>

    <h1>Pƒ∞≈ûTƒ∞ PRO</h1>

    <div id="giris-ekrani" class="panel">
        <h2 id="form-baslik" style="color: var(--gold); margin-bottom: 20px;">Giri≈ü Yap</h2>
        <div id="kayit-ozel-alan" style="display: none;">
            <input type="text" id="adSoyad" placeholder="Ad Soyad" style="width: 85%;">
        </div>
        <input type="email" id="email" placeholder="E-posta" style="width: 85%;">
        <input type="password" id="sifre" placeholder="≈ûifre" style="width: 85%;">
        <div style="margin-top: 10px;">
            <button id="ana-islem-btn" onclick="girisYap()" style="background:#3498db; color:white;">Giri≈ü Yap</button>
            <p id="form-degistir-text" class="form-link">
                Hesabƒ±nƒ±z yok mu? <span onclick="toggleForm('kayit')" style="color:var(--gold); cursor:pointer; text-decoration:underline;">Kayƒ±t Ol</span>
            </p>
        </div>
    </div>

    <div id="lobi-ekrani" class="panel" style="display:none;">
        <button class="cikis-yap-btn" onclick="otaturumuKapat()">Oturumu Kapat</button>
        <div id="profil-bilgi" style="margin-bottom:15px; color:var(--gold); border-bottom:1px solid #444; padding-bottom:10px;"></div>
        <div style="display: flex; gap: 10px; align-items: center; justify-content: center; margin-bottom: 10px;">
            <select id="mod-secim">
                <option value="bot">Bot (Tek)</option>
                <option value="2">2 Ki≈üilik</option>
                <option value="4">E≈üli (2v2)</option>
            </select>
            <input type="number" id="bitis-puani" value="101" style="width:60px;">
        </div>
        <button onclick="masaKur()">Masa Kur</button>
        <button onclick="liderlikTablosuGoster()" style="background:#9b59b6; color:white;">Liderlik Tablosu</button>
        <div id="liderlik-listesi"></div>
        <hr>
        <div id="masa-listesi">Masalar y√ºkleniyor...</div>
    </div>

    <div id="oyun-alani">
        <button class="ayril-btn" onclick="oyundanAyril()">Masadan Ayrƒ±l</button>
        
        <div id="aktif-el-display" class="el-sayaci">1. El</div>
        
        <div id="rakip-ismi" class="oyuncu-etiket">Oyuncular Bekleniyor...</div>
        <div id="deste-bilgi">Destede Kalan: 52</div>
        <div id="durum" style="font-weight: bold; color: var(--gold); margin-bottom: 5px;">Baƒülanƒ±lƒ±yor...</div>
        
        <div class="masa" id="yerdeki-kartlar"></div>
        
        <div id="benim-ismim" class="oyuncu-etiket">Siz</div>
        <div class="el" id="benim-elim"></div>
        
        <div id="skor-tablosu-konteynir" style="width: 90%; max-width: 600px; margin-top: 20px;">
            <table>
                <thead>
                    <tr>
                        <th>El No</th>
                        <th id="th-oyuncu1">1. Taraf</th>
                        <th id="th-oyuncu2">2. Taraf</th>
                    </tr>
                </thead>
                <tbody id="tablo-govde"></tbody>
            </table>
            <button id="lobiye-don" style="display:none; margin-top:15px;" onclick="location.reload()">Lobiye D√∂n</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBBiXjQRhUSXwbgoOmcKQ3Gq0UKplZAZBY",
            authDomain: "pisti-f0c29.firebaseapp.com",
            databaseURL: "https://pisti-f0c29-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pisti-f0c29",
            storageBucket: "pisti-f0c29.firebasestorage.app",
            messagingSenderId: "85802639604",
            appId: "1:85802639604:web:98ffe6d21f3d1651f0bea1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let aktifUser = null, aktifMasaId = null, benimRolum = null, benimIsmim = "";

        // AUTH VE FORM ƒ∞≈ûLEMLERƒ∞
        window.toggleForm = (mod) => {
            const kayitAlani = document.getElementById('kayit-ozel-alan');
            const baslik = document.getElementById('form-baslik');
            const btn = document.getElementById('ana-islem-btn');
            const text = document.getElementById('form-degistir-text');
            if(mod === 'kayit') {
                kayitAlani.style.display = 'block'; baslik.textContent = 'Kayƒ±t Ol'; btn.textContent = 'Kayƒ±t Ol';
                btn.onclick = () => window.kayitOl();
                text.innerHTML = `Zaten hesabƒ±nƒ±z var mƒ±? <span onclick="toggleForm('giris')" style="color:var(--gold); cursor:pointer;">Giri≈ü Yap</span>`;
            } else {
                kayitAlani.style.display = 'none'; baslik.textContent = 'Giri≈ü Yap'; btn.textContent = 'Giri≈ü Yap';
                btn.onclick = () => window.girisYap();
                text.innerHTML = `Hesabƒ±nƒ±z yok mu? <span onclick="toggleForm('kayit')" style="color:var(--gold); cursor:pointer;">Kayƒ±t Ol</span>`;
            }
        };

        window.kayitOl = () => {
            const ad = document.getElementById('adSoyad').value, m = document.getElementById('email').value, s = document.getElementById('sifre').value;
            if(!ad) return alert("L√ºtfen adƒ±nƒ±zƒ± girin.");
            createUserWithEmailAndPassword(auth, m, s).then(res => {
                set(ref(db, 'users/' + res.user.uid), { adSoyad: ad, email: m, genelPuan: 0, oyunSayisi: 0, galibiyet: 0, sonBes: [] });
            }).catch(e => alert("Kayƒ±t hatasƒ±: " + e.message));
        };

        window.girisYap = () => {
            const m = document.getElementById('email').value, s = document.getElementById('sifre').value;
            signInWithEmailAndPassword(auth, m, s).catch(e => alert("Giri≈ü hatasƒ±: " + e.message));
        };

        window.otaturumuKapat = () => { if(confirm("√áƒ±kƒ±≈ü yapmak istediƒüinize emin misiniz?")) signOut(auth).then(() => location.reload()); };

        onAuthStateChanged(auth, user => { 
            if(user) { 
                aktifUser = user; document.getElementById('giris-ekrani').style.display='none'; document.getElementById('lobi-ekrani').style.display='block';
                onValue(ref(db, `users/${user.uid}`), s => {
                    const d = s.val(); if(d) { benimIsmim = d.adSoyad; document.getElementById('profil-bilgi').innerHTML = `<b>${d.adSoyad}</b><br>Genel Puan: ${d.genelPuan || 0}`; }
                });
                lobiTakip(); 
            } else {
                document.getElementById('giris-ekrani').style.display='block'; document.getElementById('lobi-ekrani').style.display='none';
            }
        });

        // OYUN VE MASA Y√ñNETƒ∞Mƒ∞
        function lobiTakip() {
            onValue(ref(db, 'lobiler/'), snap => {
                const list = document.getElementById('masa-listesi'); list.innerHTML = "";
                const data = snap.val(); if(!data) { list.innerHTML = "Aktif masa yok."; return; }
                for(let id in data) {
                    if(data[id].durum === "bekliyor") {
                        const count = Object.keys(data[id].oyuncular).length;
                        const modStr = data[id].mod === "4" ? "E≈üli" : "2 Ki≈üilik";
                        const div = document.createElement('div'); div.style.margin = "10px 0";
                        const isOwner = data[id].oyuncular.oyuncu1.uid === aktifUser.uid;
                        div.innerHTML = `<span>[${modStr}] ${data[id].oyuncular.oyuncu1.isim} Masasƒ± (${count}/${data[id].mod === "4" ? 4 : 2})</span> ` + 
                            (isOwner ? `<button onclick="masaSil('${id}')" style="width: auto; padding: 5px 15px; background: #e74c3c;">Masayƒ± Sil</button>` : `<button onclick="masaKatil('${id}')" style="width: auto; padding: 5px 15px;">Katƒ±l</button>`);
                        list.appendChild(div);
                    }
                }
            });
        }

        window.masaSil = async (id) => { if(confirm("Masayƒ± silmek istediƒüinize emin misiniz?")) await remove(ref(db, 'lobiler/' + id)); };

        window.masaKur = async () => {
            const mod = document.getElementById('mod-secim').value, bitis = document.getElementById('bitis-puani').value, id = "masa_" + Date.now();
            const yeniMasa = { 
                mod: mod, hedef: parseInt(bitis), durum: mod === "bot" ? "basladi" : "bekliyor", 
                sira: "oyuncu1", sonKazan: "oyuncu1", masaKartlari: [], skorGecmisi: [], 
                oyuncular: { oyuncu1: { uid: aktifUser.uid, isim: benimIsmim, puan: 0, alinan: [], toplamSkor: 0, pistiSayisi: 0 } } 
            };
            if(mod === "bot") { 
                yeniMasa.oyuncular.oyuncu2 = { uid: "BOT", isim: "Bilgisayar", puan: 0, alinan: [], toplamSkor: 0, pistiSayisi: 0 }; 
                const d = desteYap(); yeniMasa.masaKartlari = d.splice(0,4); yeniMasa.oyuncular.oyuncu1.el = d.splice(0,4); yeniMasa.oyuncular.oyuncu2.el = d.splice(0,4); yeniMasa.deste = d; 
            }
            await set(ref(db, 'lobiler/' + id), yeniMasa); masaGiris(id, "oyuncu1");
        };

        window.masaKatil = async (id) => {
            const snap = await get(ref(db, `lobiler/${id}`)); const oyun = snap.val();
            const idx = Object.keys(oyun.oyuncular).length + 1; const rol = "oyuncu" + idx;
            let up = { [`oyuncular/${rol}`]: { uid: aktifUser.uid, isim: benimIsmim, puan: 0, alinan: [], toplamSkor: 0, pistiSayisi: 0 } };
            const max = oyun.mod === "4" ? 4 : 2;
            if(idx === max) {
                const d = desteYap(); up.durum = "basladi"; up.masaKartlari = d.splice(0,4); up.deste = d;
                for(let i=1; i<=max; i++) up[`oyuncular/oyuncu${i}/el`] = d.splice(0,4);
            }
            await update(ref(db, `lobiler/${id}`), up); masaGiris(id, rol);
        };

        function masaGiris(id, rol) {
            aktifMasaId = id; benimRolum = rol;
            document.getElementById('lobi-ekrani').style.display = 'none'; document.getElementById('oyun-alani').style.display = 'flex';
            onValue(ref(db, `lobiler/${id}`), snap => { 
                const data = snap.val(); if(data) { oyunGuncelle(data); if(data.durum === "basladi" && data.mod === "bot" && data.sira === "oyuncu2") setTimeout(botHamlesi, 1000); } 
            });
        }

        // OYUN AKI≈ûI
        function oyunGuncelle(data) {
            const yer = document.getElementById('yerdeki-kartlar'), elDiv = document.getElementById('benim-elim');
            const elSayaci = document.getElementById('aktif-el-display');
            
            // El Numarasƒ± G√ºncelleme
            const guncelEl = (data.skorGecmisi ? data.skorGecmisi.length : 0) + 1;
            elSayaci.textContent = `${guncelEl}. El`;

            document.getElementById('deste-bilgi').textContent = `Destede Kalan: ${data.deste ? data.deste.length : 0} kart`;

            if(data.mod === "4") {
                document.getElementById('th-oyuncu1').textContent = `1. Takƒ±m`;
                document.getElementById('th-oyuncu2').textContent = `2. Takƒ±m`;
            } else {
                document.getElementById('th-oyuncu1').textContent = data.oyuncular.oyuncu1.isim;
                document.getElementById('th-oyuncu2').textContent = data.oyuncular.oyuncu2 ? data.oyuncular.oyuncu2.isim : "Bekleniyor...";
            }

            if(data.durum === "bitti") {
                yer.innerHTML = ""; elDiv.innerHTML = "";
                document.getElementById('durum').innerHTML = "üèÜ OYUN Bƒ∞TTƒ∞ üèÜ";
                document.getElementById('lobiye-don').style.display = "block";
                skorTablosuGuncelle(data); return;
            }

            document.getElementById('durum').textContent = data.sira === benimRolum ? "SIRA Sƒ∞ZDE" : "RAKƒ∞PTE...";
            yer.innerHTML = "";
            const mk = data.masaKartlari || [];
            let gap = Math.max(10, Math.min(25, 350 / (mk.length + 1)));
            mk.forEach((k, i) => {
                const div = document.createElement('div'); div.innerHTML = kartHtml(k, i, false);
                const kd = div.firstChild; kd.style.left = `calc(50% + ${(i * gap) - (mk.length * gap / 2)}px)`;
                kd.style.top = "50%"; kd.style.transform = "translateY(-50%)"; kd.style.zIndex = i;
                if(i === mk.length - 1) kd.style.border = "2px solid var(--gold)";
                yer.appendChild(kd);
            });

            elDiv.innerHTML = "";
            (data.oyuncular[benimRolum]?.el || []).forEach((k, i) => {
                const div = document.createElement('div'); div.innerHTML = kartHtml(k, i, true);
                elDiv.appendChild(div.firstChild);
            });
            skorTablosuGuncelle(data);
        }

        window.kartAt = async (idx) => {
            const snap = await get(ref(db, `lobiler/${aktifMasaId}`)); const oyun = snap.val();
            if(!oyun || oyun.sira !== benimRolum) return;
            const hamle = calculateMove(oyun, benimRolum, idx);
            await update(ref(db, `lobiler/${aktifMasaId}`), hamle.updates);
            if(hamle.updates.durum === "hesapla") finalHesapla(aktifMasaId);
        };

        function calculateMove(oyun, suankiSira, idx) {
            let el = [...oyun.oyuncular[suankiSira].el]; let atilan = el.splice(idx, 1)[0];
            let masa = oyun.masaKartlari || []; let pPuan = oyun.oyuncular[suankiSira].puan || 0;
            let pSayisi = oyun.oyuncular[suankiSira].pistiSayisi || 0;
            let alinan = oyun.oyuncular[suankiSira].alinan || []; let sonKazan = oyun.sonKazan;
            let max = oyun.mod === "4" ? 4 : 2;
            let siradaki = "oyuncu" + ((parseInt(suankiSira.replace("oyuncu", "")) % max) + 1);

            if(masa.length > 0) {
                let ust = masa[masa.length - 1];
                if(atilan.value === "J" || atilan.value === ust.value) {
                    sonKazan = suankiSira;
                    let mText = atilan.value === "J" ? "VALE ƒ∞LE ALDI!" : `${atilan.value} E≈ûLEMESƒ∞!`;
                    if(masa.length === 1 && atilan.value === {value: ust.value}.value) { 
                        mText = atilan.value === "J" ? "VALE Pƒ∞≈ûTƒ∞!" : "Pƒ∞≈ûTƒ∞!";
                        pPuan += (atilan.value === "J") ? 25 : 10; pSayisi += 1;
                    }
                    pistiEfektiGoster(mText); alinan = [...alinan, ...masa, atilan]; masa = [];
                } else masa.push(atilan);
            } else masa.push(atilan);

            let updates = { masaKartlari: masa, sira: siradaki, sonKazan: sonKazan };
            updates[`oyuncular/${suankiSira}/el`] = el; updates[`oyuncular/${suankiSira}/puan`] = pPuan; 
            updates[`oyuncular/${suankiSira}/pistiSayisi`] = pSayisi; updates[`oyuncular/${suankiSira}/alinan`] = alinan;
            
            let bittiMi = true;
            for(let i=1; i<=max; i++) { if((i === parseInt(suankiSira.replace("oyuncu","")) ? el : (oyun.oyuncular["oyuncu"+i].el || [])).length > 0) bittiMi = false; }
            if(bittiMi) {
                if(oyun.deste && oyun.deste.length > 0) {
                    let d = [...oyun.deste]; for(let i=1; i<=max; i++) updates[`oyuncular/oyuncu${i}/el`] = d.splice(0, 4);
                    updates.deste = d;
                } else updates.durum = "hesapla";
            }
            return { updates };
        }

        async function finalHesapla(id) {
            const snap = await get(ref(db, `lobiler/${id}`)); const oyun = snap.val();
            const mod = oyun.mod;

            const getDetayliPuan = (cards) => {
                let p = 0; let d = [];
                (cards || []).forEach(k => {
                    if(k.value === "A") { p += 1; d.push("A"); }
                    if(k.value === "J") { p += 1; d.push("J"); }
                    if(k.suit === "‚ô£" && k.value === "2") { p += 2; d.push("‚ô£2"); }
                    if(k.suit === "‚ô¶" && k.value === "10") { p += 3; d.push("‚ô¶10"); }
                });
                let counts = {}; d.forEach(x => counts[x] = (counts[x] || 0) + 1);
                let finalD = Object.entries(counts).map(([k, v]) => v > 1 ? `${v}x${k}` : k).join(", ");
                return { p, detay: finalD };
            };

            let players = [];
            for(let i=1; i<=(mod==="4"?4:2); i++) {
                let pData = oyun.oyuncular["oyuncu"+i];
                let alinan = [...(pData.alinan || [])];
                if(oyun.sonKazan === "oyuncu"+i) alinan.push(...(oyun.masaKartlari || []));
                let pInfo = getDetayliPuan(alinan);
                players.push({ id: "oyuncu"+i, puan: pData.puan + pInfo.p, count: alinan.length, detay: pInfo.detay, pisti: pData.pistiSayisi });
            }

            let t1, t2, det1, det2, t1k, t2k;
            if(mod === "4") {
                t1 = players[0].puan + players[2].puan; t2 = players[1].puan + players[3].puan;
                t1k = players[0].count + players[2].count; t2k = players[1].count + players[3].count;
                let pisti1 = players[0].pisti + players[2].pisti, pisti2 = players[1].pisti + players[3].pisti;
                det1 = (pisti1 > 0 ? `<span class="badge-detay">${pisti1} Pi≈üti</span> ` : "") + [players[0].detay, players[2].detay].filter(Boolean).join(", ");
                det2 = (pisti2 > 0 ? `<span class="badge-detay">${pisti2} Pi≈üti</span> ` : "") + [players[1].detay, players[3].detay].filter(Boolean).join(", ");
            } else {
                t1 = players[0].puan; t2 = players[1].puan; t1k = players[0].count; t2k = players[1].count;
                det1 = (players[0].pisti > 0 ? `<span class="badge-detay">${players[0].pisti} Pi≈üti</span> ` : "") + players[0].detay;
                det2 = (players[1].pisti > 0 ? `<span class="badge-detay">${players[1].pisti} Pi≈üti</span> ` : "") + players[1].detay;
            }

            if(t1k > t2k) { t1 += 3; det1 += (det1 ? ", " : "") + "Kart Fazlasƒ±"; }
            else if(t2k > t1k) { t2 += 3; det2 += (det2 ? ", " : "") + "Kart Fazlasƒ±"; }

            const s1 = (oyun.oyuncular.oyuncu1.toplamSkor || 0) + t1, s2 = (oyun.oyuncular.oyuncu2.toplamSkor || 0) + t2;
            const bitti = s1 >= oyun.hedef || s2 >= oyun.hedef;

            const up = { 
                skorGecmisi: [...(oyun.skorGecmisi || []), { oyuncu1: t1, oyuncu2: t2, d1: det1, d2: det2 }], 
                durum: bitti ? "bitti" : "basladi" 
            };

            for(let i=1; i<=(mod==="4"?4:2); i++) { 
                up[`oyuncular/oyuncu${i}/toplamSkor`] = (i % 2 !== 0) ? s1 : s2; 
                up[`oyuncular/oyuncu${i}/puan`] = 0; up[`oyuncular/oyuncu${i}/alinan`] = []; up[`oyuncular/oyuncu${i}/pistiSayisi`] = 0;
            }

            if(!bitti) {
                const d = desteYap(); up.masaKartlari = d.splice(0,4); up.deste = d;
                for(let i=1; i<=(mod==="4"?4:2); i++) up[`oyuncular/oyuncu${i}/el`] = d.splice(0,4);
                pistiEfektiGoster(`${(oyun.skorGecmisi ? oyun.skorGecmisi.length : 0) + 2}. El Ba≈ülƒ±yor!`);
            }
            await update(ref(db, `lobiler/${id}`), up);
        }

        // YARDIMCI ARA√áLAR
        function kartHtml(k, i, t) {
            return `<div class="kart ${k.color}" ${t ? `onclick="kartAt(${i})"` : ""}>
                <div>${k.value}</div><div style="font-size:35px; text-align:center">${k.suit}</div><div style="transform:rotate(180deg)">${k.value}</div>
            </div>`;
        }

        function desteYap() {
            const s = ["‚ô•","‚ô¶","‚ô£","‚ô†"], v = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
            let d = []; s.forEach(x => v.forEach(y => d.push({suit:x, value:y, color:(x==="‚ô•"||x==="‚ô¶")?"kirmizi":"siyah"})));
            return d.sort(() => Math.random() - 0.5);
        }

        function skorTablosuGuncelle(data) {
            const govde = document.getElementById('tablo-govde'); govde.innerHTML = "";
            (data.skorGecmisi || []).forEach((s, i) => { 
                govde.innerHTML += `<tr><td>${i+1}. El</td><td>${s.oyuncu1} <span class="detay-text">${s.d1 || ""}</span></td><td>${s.oyuncu2} <span class="detay-text">${s.d2 || ""}</span></td></tr>`; 
            });
            govde.innerHTML += `<tr style="color:var(--gold); font-weight:bold; background:rgba(255,255,255,0.1)"><td>TOPLAM</td><td>${data.oyuncular.oyuncu1.toplamSkor}</td><td>${data.oyuncular.oyuncu2.toplamSkor}</td></tr>`;
        }

        function pistiEfektiGoster(msg) {
            const el = document.getElementById('pisti-efekt');
            el.textContent = msg; el.classList.remove('pisti-anim');
            void el.offsetWidth; el.classList.add('pisti-anim');
            setTimeout(() => el.classList.remove('pisti-anim'), 2000);
        }

        async function botHamlesi() {
            const snap = await get(ref(db, `lobiler/${aktifMasaId}`)); const oyun = snap.val();
            if(!oyun || oyun.sira !== "oyuncu2" || oyun.durum !== "basladi") return;
            const botEli = oyun.oyuncular.oyuncu2.el || []; if(botEli.length === 0) return;
            let idx = 0; const yerdeki = (oyun.masaKartlari && oyun.masaKartlari.length > 0) ? oyun.masaKartlari[oyun.masaKartlari.length - 1] : null;
            botEli.forEach((k, i) => { if(yerdeki && (k.value === yerdeki.value || k.value === "J")) idx = i; });
            const hamle = calculateMove(oyun, "oyuncu2", idx);
            await update(ref(db, `lobiler/${aktifMasaId}`), hamle.updates);
            if(hamle.updates.durum === "hesapla") finalHesapla(aktifMasaId);
        }

        window.liderlikTablosuGoster = async () => {
            const s = await get(ref(db, 'users/')); const data = s.val();
            let arr = data ? Object.values(data).sort((a,b) => (b.genelPuan || 0) - (a.genelPuan || 0)) : [];
            let html = `<h3>üèÜ Liderlik Tablosu</h3><table><thead><tr><th>Oyuncu</th><th>Puan</th><th>O/G</th><th>Form</th></tr></thead><tbody>`;
            arr.forEach(u => {
                let fHtml = ''; (u.sonBes || []).forEach(x => fHtml += `<span class="son-bes-item ${x==='G'?'win':'lose'}">${x}</span>`);
                html += `<tr><td>${u.adSoyad}</td><td>${u.genelPuan||0}</td><td>${u.oyunSayisi||0}/${u.galibiyet||0}</td><td>${fHtml}</td></tr>`;
            });
            document.getElementById('liderlik-listesi').innerHTML = html + "</tbody></table>";
        };

        window.oyundanAyril = async () => {
            if(confirm("Masadan ayrƒ±lmak √ºzeresiniz. Devam eden oyundan √ßƒ±karsanƒ±z 100 puan ceza alƒ±rsƒ±nƒ±z?")) {
                const snap = await get(ref(db, `lobiler/${aktifMasaId}`)); const oyun = snap.val();
                if(oyun && oyun.durum === "basladi" && oyun.mod !== "bot") {
                    const r = ref(db, `users/${aktifUser.uid}`); const s = await get(r); const d = s.val();
                    if(d) await update(r, { genelPuan: (d.genelPuan || 0) - 100 });
                }
                location.reload();
            }
        };
    </script>
</body>
</html>